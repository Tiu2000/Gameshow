<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wheel of Knowledge - AutoSave</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Load Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0b1a37; color: #e5e7eb; }
        .letter-box {
            display: inline-flex; justify-content: center; align-items: center;
            width: 40px; height: 50px; margin: 2px;
            background-color: #3b82f6; color: #fcd34d;
            font-size: 24px; font-weight: 900; border-radius: 6px;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3); transition: all 0.2s;
        }
        .letter-box.revealed { background-color: #fcd34d; color: #1f2937; transform: scale(1.05); }
        .letter-box.space { background-color: transparent; box-shadow: none; width: 15px; }
        .letter-box.newline { display: block; height: 0; width: 100%; margin: 0; }
        
        /* Button Styles */
        .btn-action {
            @apply p-3 px-6 rounded-lg font-bold transition-transform duration-150 shadow-lg border-b-4 border-opacity-50;
        }
        .btn-action:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 0; margin-top: 2px; }
        .btn-action:disabled { @apply opacity-50 cursor-not-allowed transform-none border-b-4; }

        @media (min-width: 768px) {
            .letter-box { width: 50px; height: 60px; margin: 3px; font-size: 28px; }
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center">

    <div class="max-w-5xl w-full">
        <!-- Header -->
        <header class="text-center mb-4">
            <h1 class="text-3xl md:text-5xl font-black text-white mb-1 tracking-tight">WHEEL OF KNOWLEDGE</h1>
            <p id="category-display" class="text-lg font-semibold text-indigo-300 bg-indigo-900/50 inline-block px-4 py-1 rounded-full">Category: Loading...</p>
        </header>

        <!-- Scoreboard -->
        <div id="scoreboard-container" class="flex flex-wrap justify-center gap-2 mb-6">
            <!-- Scores injected here -->
        </div>

        <!-- Team Controls -->
        <div class="flex justify-center gap-3 mb-6">
            <button id="add-team-btn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm font-bold">+ Team</button>
            <button id="remove-team-btn" class="px-3 py-1 bg-gray-700 hover:bg-gray-600 text-white rounded text-sm font-bold">- Team</button>
        </div>

        <!-- Board -->
        <div id="puzzle-board" class="p-4 md:p-8 bg-gray-800/80 backdrop-blur-sm border border-gray-700 rounded-2xl shadow-2xl mb-6 flex flex-wrap justify-center min-h-[120px]"></div>

        <!-- Status/Wheel Output -->
        <div class="text-center mb-6 h-20">
            <p id="wheel-result" class="text-3xl font-black text-yellow-400 mb-1 drop-shadow-md"></p>
            <p id="game-message" class="text-lg text-white font-medium"></p>
        </div>

        <!-- Game Controls -->
        <div class="flex flex-col md:flex-row justify-center items-center gap-3 mb-6">
            <button id="spin-btn" class="btn-action bg-red-600 border-red-800 text-white hover:bg-red-500 w-full md:w-auto min-w-[140px]">SPIN</button>
            <button id="vowel-btn" class="btn-action bg-green-600 border-green-800 text-white hover:bg-green-500 w-full md:w-auto min-w-[140px]">BUY VOWEL ($250)</button>
            <button id="solve-btn" class="btn-action bg-yellow-500 border-yellow-700 text-gray-900 hover:bg-yellow-400 w-full md:w-auto min-w-[140px]">SOLVE</button>
        </div>

        <!-- Input Section -->
        <div id="input-area" class="bg-gray-800 p-4 rounded-xl shadow-lg border border-gray-700">
            <label for="guess-input" id="input-label" class="block text-lg font-medium mb-2 text-gray-300">Wait for your turn...</label>
            <div class="flex gap-2">
                <input type="text" id="guess-input" maxlength="1" 
                       class="flex-grow p-3 bg-gray-900 border border-gray-600 rounded-lg text-white text-2xl uppercase font-bold tracking-wider focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
                       placeholder="..." disabled autocomplete="off">
                <button id="submit-guess" class="btn-action bg-blue-600 border-blue-800 text-white hover:bg-blue-500 min-w-[100px]" disabled>OK</button>
            </div>
            <div class="mt-3 text-sm text-gray-400 flex justify-between px-1">
                <span id="cons-display">Consonants: -</span>
                <span id="vow-display">Vowels: -</span>
            </div>
        </div>

        <!-- Generator & Reset -->
        <div class="mt-8 pt-4 border-t border-gray-700 flex justify-center gap-6">
            <button id="generate-puzzle-btn" class="text-sm text-purple-400 hover:text-purple-300 underline">‚ú® Generate New Puzzles (AI)</button>
            <button id="reset-game-btn" class="text-sm text-red-400 hover:text-red-300 underline">üóëÔ∏è Reset Game & Scores</button>
        </div>
    </div>

    <script>
        // --- 1. ROBUST AUDIO CONTROLLER ---
        const Audio = {
            ctx: null,
            synths: {},
            initialized: false,

            async init() {
                if (this.initialized) return;
                try {
                    await Tone.start();
                    console.log("Audio Context Started");
                    
                    // Create synths only after start to ensure context connectivity
                    this.synths.chime = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 1 }
                    }).toDestination();
                    this.synths.chime.volume.value = -5;

                    this.synths.buzz = new Tone.MembraneSynth().toDestination();
                    this.synths.buzz.volume.value = -2;

                    this.synths.click = new Tone.MembraneSynth({
                        pitchDecay: 0.008, octaves: 2, envelope: { attack: 0.001, decay: 0.2, sustain: 0 }
                    }).toDestination();

                    this.synths.win = new Tone.PolySynth(Tone.Synth).toDestination();

                    this.initialized = true;
                } catch (e) {
                    console.warn("Audio init failed", e);
                }
            },

            play(type) {
                if (!this.initialized) this.init(); // Try init on fly if missed
                if (Tone.context.state !== 'running') Tone.context.resume();

                const now = Tone.now();
                try {
                    switch (type) {
                        case 'correct':
                            this.synths.chime.triggerAttackRelease(["E5", "G5", "C6"], "8n", now);
                            break;
                        case 'wrong':
                            this.synths.buzz.triggerAttackRelease("C2", "8n", now);
                            break;
                        case 'turn':
                            this.synths.click.triggerAttackRelease("C4", "32n", now);
                            break;
                        case 'win':
                            this.synths.win.triggerAttackRelease(["C4", "E4", "G4", "C5"], "4n", now);
                            this.synths.win.triggerAttackRelease(["E4", "G4", "C5", "E5"], "4n", now + 0.2);
                            this.synths.win.triggerAttackRelease(["G4", "C5", "E5", "G5"], "2n", now + 0.4);
                            break;
                    }
                } catch (e) { /* Ignore audio errors to keep game running */ }
            }
        };

        // --- 2. GAME CONSTANTS & CONFIG ---
        const PHASES = {
            SETUP: 'SETUP',           // Initial state
            SPIN_OR_ACTION: 'ACTION', // Choose: Spin, Buy Vowel, Solve
            GUESS_CONSONANT: 'CONS',  // Input: Consonant
            GUESS_VOWEL: 'VOWEL',     // Input: Vowel
            GUESS_FREE: 'FREE',       // Input: Any letter (Free Play)
            SOLVE: 'SOLVE'            // Input: Full phrase
        };

        const WHEEL_VALUES = [
            500, 600, 300, 700, 400, 900, 
            500, 600, 300, 800, 550, 
            'BANKRUPT', 'LOSE_TURN', 'FREE_PLAY', 'BANKRUPT'
        ];

        const VOWEL_COST = 250;
        let PUZZLES = [
            { category: "Geography", puzzle: "THE GRAND CANYON" },
            { category: "Science", puzzle: "PHOTOSYNTHESIS" },
            { category: "History", puzzle: "THE INDUSTRIAL REVOLUTION" },
            { category: "Literature", puzzle: "ROMEO AND JULIET" }
        ];

        // --- 3. GAME STATE & PERSISTENCE ---
        const STORAGE_KEY = 'wheel_of_knowledge_v2';

        let state = {
            phase: PHASES.SETUP,
            teams: [ {id:1, score:0, round:0}, {id:2, score:0, round:0}, {id:3, score:0, round:0} ],
            turnIndex: 0,
            puzzleIndex: 0,
            puzzle: "",
            category: "",
            revealed: [], // Changed to array for JSON serialization
            guessedConsonants: [], // Changed to array for JSON serialization
            guessedVowels: [], // Changed to array for JSON serialization
            wheelValue: 0
        };

        function saveState() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = parsed;
                    // Ensure these are rendered correctly
                    updateUI();
                    renderBoard();
                    renderTeams();
                    el.msg.textContent = `Game Restored! Team ${state.teams[state.turnIndex].id}'s turn.`;
                    return true;
                } catch (e) {
                    console.error("Failed to load save", e);
                    return false;
                }
            }
            return false;
        }

        function resetGame() {
            if(!confirm("Are you sure you want to reset scores and teams?")) return;
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }

        // --- 4. DOM ELEMENTS ---
        const el = {
            board: document.getElementById('puzzle-board'),
            cat: document.getElementById('category-display'),
            msg: document.getElementById('game-message'),
            res: document.getElementById('wheel-result'),
            input: document.getElementById('guess-input'),
            label: document.getElementById('input-label'),
            scoreContainer: document.getElementById('scoreboard-container'),
            consDisplay: document.getElementById('cons-display'),
            vowDisplay: document.getElementById('vow-display'),
            btns: {
                spin: document.getElementById('spin-btn'),
                vowel: document.getElementById('vowel-btn'),
                solve: document.getElementById('solve-btn'),
                submit: document.getElementById('submit-guess'),
                add: document.getElementById('add-team-btn'),
                rem: document.getElementById('remove-team-btn'),
                gen: document.getElementById('generate-puzzle-btn'),
                reset: document.getElementById('reset-game-btn')
            }
        };

        // --- 5. CORE LOGIC ---

        function initGame() {
            // Try to load saved game first
            if (loadState()) {
                // If restored, just attach audio listener and return
                return;
            }
            // Otherwise start fresh
            loadPuzzle(0);
            renderTeams();
            Audio.play('turn'); // Pre-load audio buffer
        }

        function loadPuzzle(idx) {
            if (idx >= PUZZLES.length) {
                el.board.innerHTML = "<h2 class='text-white text-2xl'>Game Over!</h2>";
                state.phase = PHASES.SETUP;
                updateUI();
                return;
            }
            state.puzzleIndex = idx;
            const p = PUZZLES[idx];
            state.puzzle = p.puzzle.toUpperCase();
            state.category = p.category;
            
            // Reset arrays for new puzzle
            state.revealed = [];
            state.guessedConsonants = [];
            state.guessedVowels = [];
            
            // Add spaces and punctuation to revealed automatically
            for(let char of state.puzzle) {
                if(!/[A-Z]/.test(char)) {
                    if(!state.revealed.includes(char)) state.revealed.push(char);
                }
            }
            
            state.teams.forEach(t => t.round = 0);
            state.phase = PHASES.SPIN_OR_ACTION;
            
            el.cat.textContent = `Category: ${state.category}`;
            el.res.textContent = "";
            el.msg.textContent = `Team ${state.teams[state.turnIndex].id} start!`;
            
            renderBoard();
            renderTeams();
            updateUI();
            saveState();
        }

        // --- INPUT HANDLERS ---

        function onSpin() {
            Audio.play('click');
            const slice = WHEEL_VALUES[Math.floor(Math.random() * WHEEL_VALUES.length)];
            
            if (typeof slice === 'number') {
                state.wheelValue = slice;
                state.phase = PHASES.GUESS_CONSONANT;
                el.res.textContent = `$${slice}`;
                el.res.className = "text-3xl font-black text-green-400 mb-1";
                el.msg.textContent = "Enter a consonant.";
            } else {
                handleSpecialSlice(slice);
            }
            updateUI();
            saveState();
        }

        function handleSpecialSlice(slice) {
            const team = state.teams[state.turnIndex];
            if (slice === 'BANKRUPT') {
                team.round = 0;
                el.res.textContent = "BANKRUPT!";
                el.res.className = "text-3xl font-black text-red-500 mb-1";
                Audio.play('wrong');
                nextTurn();
            } else if (slice === 'LOSE_TURN') {
                el.res.textContent = "LOSE A TURN";
                el.res.className = "text-3xl font-black text-red-500 mb-1";
                Audio.play('wrong');
                nextTurn();
            } else if (slice === 'FREE_PLAY') {
                state.wheelValue = 500; // Free play worth 500
                state.phase = PHASES.GUESS_FREE; // Special phase
                el.res.textContent = "FREE PLAY!";
                el.res.className = "text-3xl font-black text-yellow-400 mb-1";
                el.msg.textContent = "Guess any letter (vowels are free).";
            }
        }

        function onBuyVowel() {
            Audio.play('click');
            const team = state.teams[state.turnIndex];
            if (team.round < VOWEL_COST) return; 
            
            team.round -= VOWEL_COST;
            state.phase = PHASES.GUESS_VOWEL;
            el.res.textContent = `Bought Vowel (-$${VOWEL_COST})`;
            el.res.className = "text-xl font-bold text-blue-300 mb-1";
            el.msg.textContent = "Enter a vowel (A, E, I, O, U).";
            renderTeams();
            updateUI();
            saveState();
        }

        function onSolve() {
            Audio.play('click');
            state.phase = PHASES.SOLVE;
            el.res.textContent = "SOLVE";
            el.msg.textContent = "Enter the full puzzle solution.";
            updateUI();
            saveState();
        }

        function onSubmit() {
            Audio.play('click');
            let val = el.input.value.toUpperCase().trim();
            el.input.value = ''; 
            if (!val) return;

            // 1. Handle Full Solve
            if (state.phase === PHASES.SOLVE || val.length > 1) {
                if (val === state.puzzle) {
                    handleWin();
                } else {
                    el.msg.textContent = "Incorrect solve!";
                    Audio.play('wrong');
                    if (state.phase !== PHASES.GUESS_FREE) nextTurn();
                    else { state.phase = PHASES.SPIN_OR_ACTION; updateUI(); saveState(); }
                }
                return;
            }

            // 2. Handle Single Letter
            const letter = val.charAt(0);
            if (!/[A-Z]/.test(letter)) {
                el.msg.textContent = "Please enter a valid letter A-Z.";
                return;
            }

            const isVowel = "AEIOU".includes(letter);
            
            // Validation based on Phase
            if (state.phase === PHASES.GUESS_CONSONANT && isVowel) {
                el.msg.textContent = "Please enter a consonant, not a vowel.";
                return;
            }
            if (state.phase === PHASES.GUESS_VOWEL && !isVowel) {
                el.msg.textContent = "Please enter a Vowel (A E I O U).";
                return;
            }

            // Check duplicates
            if (state.guessedConsonants.includes(letter) || state.guessedVowels.includes(letter)) {
                el.msg.textContent = `Letter '${letter}' already guessed.`;
                if (state.phase !== PHASES.GUESS_FREE) {
                    Audio.play('wrong');
                    nextTurn(); 
                } else {
                    state.phase = PHASES.SPIN_OR_ACTION; 
                    updateUI();
                    saveState();
                }
                return;
            }

            // Register Guess
            if (isVowel) state.guessedVowels.push(letter);
            else state.guessedConsonants.push(letter);

            // Check Matches
            let count = 0;
            for (let char of state.puzzle) if (char === letter) count++;

            if (count > 0) {
                // Match Found
                Audio.play('correct');
                if(!state.revealed.includes(letter)) state.revealed.push(letter);
                
                // Calc Score
                if (!isVowel) {
                    const val = (state.phase === PHASES.GUESS_FREE) ? 500 : state.wheelValue;
                    const gain = val * count;
                    state.teams[state.turnIndex].round += gain;
                    el.res.textContent = `Found ${count} ${letter}'s! (+$${gain})`;
                } else {
                    el.res.textContent = `Found ${count} ${letter}'s!`;
                }
                el.res.className = "text-2xl font-bold text-green-400";
                
                // Check full board clear
                const allRevealed = [...state.puzzle].every(c => state.revealed.includes(c));
                if (allRevealed) {
                    handleWin();
                    return;
                }

                // Stay with current player
                state.phase = PHASES.SPIN_OR_ACTION;
            } else {
                // No Match
                Audio.play('wrong');
                el.res.textContent = `No ${letter} in puzzle.`;
                el.res.className = "text-2xl font-bold text-red-400";
                
                if (state.phase === PHASES.GUESS_FREE) {
                    state.phase = PHASES.SPIN_OR_ACTION;
                } else {
                    nextTurn();
                    return; 
                }
            }

            renderBoard();
            renderTeams();
            updateUI();
            saveState();
        }

        function nextTurn() {
            state.turnIndex = (state.turnIndex + 1) % state.teams.length;
            state.phase = PHASES.SPIN_OR_ACTION;
            el.msg.textContent = `Turn passes to Team ${state.teams[state.turnIndex].id}`;
            Audio.play('turn');
            setTimeout(() => {
                el.res.textContent = ""; 
                updateUI(); 
                renderTeams();
            }, 1500);
            updateUI();
            renderTeams();
            saveState();
        }

        function handleWin() {
            const team = state.teams[state.turnIndex];
            const winAmt = Math.max(team.round, 1000);
            team.score += winAmt;
            team.round = 0;
            
            // Reveal all
            for(let c of state.puzzle) if(!state.revealed.includes(c)) state.revealed.push(c);
            
            renderBoard();
            renderTeams();
            Audio.play('win');
            
            el.res.textContent = "PUZZLE SOLVED!";
            el.res.className = "text-4xl font-black text-yellow-400 animate-pulse";
            el.msg.textContent = `Team ${team.id} wins $${winAmt}! Next puzzle in 5s...`;
            
            state.phase = PHASES.SETUP; 
            updateUI();
            saveState();
            
            setTimeout(() => {
                loadPuzzle(state.puzzleIndex + 1);
            }, 5000);
        }

        // --- 6. RENDER & UI UPDATE ---

        function renderBoard() {
            el.board.innerHTML = '';
            // Responsive rendering
            el.cat.textContent = `Category: ${state.category}`;
            
            for (let i=0; i<state.puzzle.length; i++) {
                const char = state.puzzle[i];
                const d = document.createElement('div');
                if (char === ' ') {
                    d.className = 'letter-box space';
                } else {
                    const isRevealed = state.revealed.includes(char);
                    d.className = `letter-box ${isRevealed ? 'revealed' : ''}`;
                    d.textContent = isRevealed ? char : '';
                }
                el.board.appendChild(d);
            }
            
            // Update small tracking display
            el.consDisplay.textContent = "Consonants: " + state.guessedConsonants.sort().join(' ');
            el.vowDisplay.textContent = "Vowels: " + state.guessedVowels.sort().join(' ');
        }

        function renderTeams() {
            el.scoreContainer.innerHTML = '';
            state.teams.forEach((t, idx) => {
                const active = idx === state.turnIndex;
                const div = document.createElement('div');
                div.className = `p-2 min-w-[100px] rounded-lg border-2 text-center transition-all ${active ? 'bg-yellow-600 border-yellow-300 scale-105 shadow-xl' : 'bg-gray-700 border-gray-600 opacity-80'}`;
                div.innerHTML = `
                    <div class="text-xs font-bold uppercase tracking-wider ${active ? 'text-gray-900' : 'text-gray-400'}">Team ${t.id}</div>
                    <div class="text-xl font-black text-white">$${t.score}</div>
                    <div class="text-sm font-medium ${active ? 'text-yellow-100' : 'text-gray-500'}">Round: $${t.round}</div>
                `;
                el.scoreContainer.appendChild(div);
            });
        }

        function updateUI() {
            const phase = state.phase;
            const team = state.teams[state.turnIndex];
            const hasMoneyForVowel = team.round >= VOWEL_COST;

            // Button States
            el.btns.spin.disabled = phase !== PHASES.SPIN_OR_ACTION;
            el.btns.vowel.disabled = phase !== PHASES.SPIN_OR_ACTION || !hasMoneyForVowel;
            el.btns.solve.disabled = phase !== PHASES.SPIN_OR_ACTION;
            
            // Input State
            const inputActive = [PHASES.GUESS_CONSONANT, PHASES.GUESS_VOWEL, PHASES.GUESS_FREE, PHASES.SOLVE].includes(phase);
            el.input.disabled = !inputActive;
            el.btns.submit.disabled = !inputActive;
            
            if (inputActive) {
                el.input.focus();
                if (phase === PHASES.GUESS_CONSONANT) el.label.textContent = "Enter a Consonant:";
                else if (phase === PHASES.GUESS_VOWEL) el.label.textContent = "Enter a Vowel:";
                else if (phase === PHASES.GUESS_FREE) el.label.textContent = "Free Play! Enter any letter:";
                else if (phase === PHASES.SOLVE) el.label.textContent = "Solve the Puzzle:";
            } else {
                el.label.textContent = "Select an action above...";
            }
        }

        // --- 7. EVENT LISTENERS ---
        el.btns.spin.onclick = () => { Audio.play('click'); onSpin(); };
        el.btns.vowel.onclick = () => { Audio.play('click'); onBuyVowel(); };
        el.btns.solve.onclick = () => { Audio.play('click'); onSolve(); };
        el.btns.submit.onclick = onSubmit;
        el.input.onkeydown = (e) => { if(e.key === 'Enter') onSubmit(); };
        el.btns.reset.onclick = resetGame;

        el.btns.add.onclick = () => {
            Audio.play('click');
            if (state.teams.length < 6) {
                state.teams.push({id: state.teams.length+1, score:0, round:0});
                renderTeams();
                saveState();
            }
        };
        el.btns.rem.onclick = () => {
            Audio.play('click');
            if (state.teams.length > 2) {
                state.teams.pop();
                if (state.turnIndex >= state.teams.length) state.turnIndex = 0;
                renderTeams();
                saveState();
            }
        };

        el.btns.gen.onclick = async () => {
            Audio.play('click');
            el.btns.gen.textContent = "Loading...";
            const apiKey = ""; // Inject key
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const prompt = "Generate 5 phrases for Wheel of Fortune. Return JSON array of objects with 'category' and 'puzzle' keys. Use uppercase.";
            
            try {
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await resp.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    PUZZLES = JSON.parse(text);
                    loadPuzzle(0);
                    el.btns.gen.textContent = "‚ú® Generated!";
                    setTimeout(()=> el.btns.gen.textContent = "‚ú® Generate New Puzzles (AI)", 2000);
                }
            } catch(e) {
                console.error(e);
                el.btns.gen.textContent = "Error (Check Console)";
            }
        };

        // BOOTSTRAP
        window.onload = initGame;

    </script>
</body>
</html>
